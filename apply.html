<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apply | Aafat Gaming</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
    :root{--neon:#00ffff;--bg:#000;--glass:rgba(20,20,35,0.92)}
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Poppins',sans-serif;
      background:var(--bg); color:#fff;
      min-height:100vh; display:flex;align-items:center;justify-content:center;
      padding:22px; position:relative; overflow-x:hidden;
    }

    /* animated GIF background */
    body::before{
      content:""; position:fixed; inset:0;
      background:url('https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExMjg0dHllYXM5Zzd3ZXE4MWFubHZzZWM4emN2eHduN3QwY2kybm9oYSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/U3qYN8S0j3bpK/giphy.gif') center/cover fixed no-repeat;
      opacity:0.16; z-index:-2; pointer-events:none;
    }

    .card{
      width:100%; max-width:980px; background:var(--glass); border-radius:14px;
      padding:24px; box-shadow:0 10px 60px rgba(0,255,255,0.06); border:1px solid rgba(0,255,255,0.06);
    }

    header{text-align:center;margin-bottom:12px}
    header h1{color:var(--neon); font-size:clamp(1.4rem,3vw,2.2rem); text-shadow:0 0 16px #00ffff}
    header p{color:#bfcfd6;margin-top:6px}

    .form-row{display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    label{display:block;font-size:0.88rem;color:#9fb6bd;margin-bottom:6px}
    .input{
      flex:1 1 220px; background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.04); padding:12px 14px; border-radius:10px;
      color:#e6f7fb; outline:none; transition:all .14s;
    }
    .input:focus{box-shadow:0 0 18px rgba(0,255,255,0.08); transform:translateY(-2px)}

    .help-tip{cursor:help;font-weight:700;color:var(--neon);margin-left:8px;position:relative}
    .help-tip:hover::after{
      content:attr(data-tip);
      position:absolute; left:0; top:-110%; transform:translateY(-6px);
      background:rgba(0,0,0,0.86); color:#fff; padding:8px 10px; border-radius:8px;
      font-size:0.82rem; width:260px; white-space:normal; box-shadow:0 8px 30px rgba(0,0,0,0.6); z-index:9999;
    }

    .quiz{margin-top:14px;border-radius:10px;padding:12px;font-family:'Poppins',sans-serif}
    .question{display:flex;gap:14px;align-items:flex-start}
    .q-index{min-width:36px;color:var(--neon);font-weight:700;font-size:1.05rem;text-shadow:0 0 8px rgba(0,255,255,0.3)}
    .q-text{flex:1;color:#dff7fb;font-size:1rem;margin-bottom:10px}
    .options{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .option{
      display:flex;gap:12px;align-items:center;padding:10px 12px;border-radius:8px;background:rgba(255,255,255,0.02);
      cursor:pointer;border:1px solid rgba(255,255,255,0.02);transition:all .14s;color:#e8fbff
    }
    .option:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(0,255,255,0.03)}
    .option input{accent-color:var(--neon)}

    .controls{display:flex;gap:12px;justify-content:space-between;align-items:center;margin-top:14px;flex-wrap:wrap}
    .btn{background:transparent;padding:10px 14px;border-radius:10px;cursor:pointer;border:1px solid rgba(255,255,255,0.06);color:#e8fbff;font-weight:700}
    .btn-primary{background:var(--neon);color:#000;border-color:transparent;box-shadow:0 8px 30px rgba(0,255,255,0.12)}
    .btn:active{transform:translateY(2px)}
    .progress{color:#9fb6bd;font-size:0.95rem}
    .status{margin-top:12px;color:#dff7fb;font-weight:700}
    .hidden{display:none}
    .result{ text-align:center;margin-top:16px;padding:14px;border-radius:10px;background:rgba(255,255,255,0.02) }
    .small{font-size:0.87rem;color:#a9c7cb;margin-top:8px}

    /* confetti animation + glow */
    @keyframes confettiFall { 0%{transform:translateY(0) rotate(0deg);opacity:1} 100%{transform:translateY(700px) rotate(720deg);opacity:0} }
    .confetti{position:fixed; top:-20px; width:10px; height:16px; border-radius:2px; z-index:9999; animation:confettiFall 2.6s linear forwards}
    @keyframes glowPulse { from{ text-shadow:0 0 6px #00ffff } to{ text-shadow:0 0 28px #00ffff } }
    .glow-pass{ animation:glowPulse 0.9s ease-in-out infinite alternate }

    @media(max-width:640px){ .form-row{flex-direction:column} .q-index{display:none} }
  </style>
</head>
<body>
  <div class="card" role="main">
    <header>
      <h1>Apply to Join — Aafat Gaming Minecraft Server</h1>
      <p>Answer the quiz. Score <strong>2+</strong> correct to be whitelisted ✅</p>
    </header>

    <script>
      /* ---------- IMPORTANT: REPLACE THESE WITH YOUR REAL VALUES ---------- */
      const ADMIN_WEBHOOK_URL  = "https://discord.com/api/webhooks/1434217150574231666/FXevYWO_oEyDFecdIYT5q4EGPBKwmnQE4ubd_fOJ9tfRJzT5MPQBINgZQo8SfsOf53ST";
      const STATUS_WEBHOOK_URL = "https://discord.com/api/webhooks/1436099433111490683/yEc9vzWMInWsBsK3xLUeuIaILdPF3ipsmaUia76eR6aFLp0FrImMXU6R--tD-iefN2M9";
      const ACCEPT_IMAGE_URL   = "https://cdn.discordapp.com/attachments/1311247446051131453/1436098847452434442/WAR.jpg?ex=690e5ec6&is=690d0d46&hm=40c06fbe5376faacf5cfa6488aed8a63780d07502d4847d949929526b47873af&";
      const REJECT_IMAGE_URL   = "https://cdn.discordapp.com/attachments/1311247446051131453/1436098847016484976/WAA.jpg?ex=690e5ec6&is=690d0d46&hm=19892b8f30e0eeeda37ee0e58e1b69f98b8767c329e77feed310f7a3cf076368&";
      const WHITELIST_API_URL  = "https://aafat-whitelist-bot.onrender.com/assign-role"; // secure bot endpoint
      const API_SECRET_KEY = "Aafat2326"; // must match Render's API_SECRET
      /* ------------------------------------------------------------------- */
    </script>

    <!-- Basic Info -->
    <div id="intro">
      <div class="form-row">
        <div style="flex:1">
          <label for="fullName">Your Name</label>
          <input id="fullName" class="input" placeholder="e.g. Meet" />
        </div>
        <div style="flex:1">
          <label for="mcName">Minecraft Username</label>
          <input id="mcName" class="input" placeholder="e.g. AafatPlayer" />
        </div>
      </div>

      <div class="form-row">
        <div style="flex:1">
          <label for="age">Your Age</label>
          <input id="age" class="input" type="number" min="8" placeholder="e.g. 20" />
        </div>
        <div style="flex:1">
          <label for="discord">Discord Username / Mention / ID
            <span class="help-tip" data-tip="How to get your Discord ID: Open User Settings → Advanced → enable Developer Mode → right-click your username → 'Copy ID'. Paste as &lt;@ID&gt; or the raw number. Example: &lt;@123456789012345678&gt;">❓</span>
          </label>
          <input id="discord" class="input" placeholder="e.g. &lt;@123456789012345678&gt; or 123456789012345678 or Meet#1234" />
        </div>
      </div>

      <div style="text-align:right;margin-top:12px">
        <button id="startBtn" class="btn btn-primary">Start Quiz</button>
      </div>
      <div id="cooldownNotice" class="small"></div>
      <div class="small">Tip: paste your mention like <code>&lt;@123456789012345678&gt;</code> to be pinged automatically.</div>
    </div>

    <!-- Quiz -->
    <div id="quizArea" class="hidden">
      <div class="quiz">
        <div class="question">
          <div class="q-index" id="qIndex">1</div>
          <div style="flex:1">
            <div class="q-text" id="qText">Question text</div>
            <div class="options" id="options"></div>
          </div>
        </div>

        <div class="controls">
          <div class="progress" id="progress">Question 1 of 10</div>
          <div>
            <button id="prevBtn" class="btn">Prev</button>
            <button id="nextBtn" class="btn btn-primary">Next</button>
          </div>
        </div>
        <div id="statusMsg" class="status"></div>
      </div>
    </div>

    <!-- Result -->
    <div id="resultArea" class="hidden">
      <div id="resultBox" class="result"></div>
      <div style="margin-top:12px;text-align:center"><button class="btn" onclick="location.reload()">Reapply</button></div>
    </div>
  </div>

<script>
/* ========================= QUIZ QUESTIONS ========================= */
const QUESTIONS = [
  { text:"What is the primary purpose of a Minecraft server?", options:[
    {id:'A',text:'To play single-player Minecraft'},
    {id:'B',text:'To allow multiple players to play together online',correct:true},
    {id:'C',text:'To create custom Minecraft skins'},
    {id:'D',text:'To host merchandise stores'}
  ]},
  { text:"Which of the following is NOT a common type of Minecraft server?", options:[
    {id:'A',text:'Survival'},{id:'B',text:'Creative'},{id:'C',text:'Adventure'},{id:'D',text:'Streaming',correct:true}
  ]},
  { text:"What command teleports you to (100,64,200)?", options:[
    {id:'A',text:'/spawn 100 64 200'},{id:'B',text:'/teleport 100 64 200'},{id:'C',text:'/tp 100 64 200',correct:true},{id:'D',text:'/go 100 64 200'}
  ]},
  { text:"Which plugin manages permissions on servers?", options:[
    {id:'A',text:'WorldEdit'},{id:'B',text:'EssentialsX'},{id:'C',text:'PermissionsEx',correct:true},{id:'D',text:'Vault'}
  ]},
  { text:"What’s the max enchantment level possible?", options:[
    {id:'A',text:'30',correct:true},{id:'B',text:'50'},{id:'C',text:'100'},{id:'D',text:'255'}
  ]},
  { text:"Which mode lets you fly freely?", options:[
    {id:'A',text:'Survival'},{id:'B',text:'Creative',correct:true},{id:'C',text:'Adventure'},{id:'D',text:'Spectator'}
  ]},
  { text:"What do you need to craft a beacon?", options:[
    {id:'A',text:'Glass and obsidian'},{id:'B',text:'Iron and redstone'},{id:'C',text:'Glass, obsidian, and Nether star',correct:true},{id:'D',text:'Gold and diamonds'}
  ]},
  { text:"How to prevent griefing on a server?", options:[
    {id:'A',text:'Using spawn protection',correct:true},{id:'B',text:'Disabling chat'},{id:'C',text:'Limiting logins'},{id:'D',text:'Removing chests'}
  ]},
  { text:"How can players gain XP?", options:[
    {id:'A',text:'By mining ores, defeating mobs, and smelting',correct:true},{id:'B',text:'Only by defeating bosses'},{id:'C',text:'By eating food'},{id:'D',text:'By crafting items'}
  ]},
  { text:"What’s the purpose of a server whitelist?", options:[
    {id:'A',text:'To allow only selected players',correct:true},{id:'B',text:'To increase speed'},{id:'C',text:'To restart the server'},{id:'D',text:'To enable creative mode'}
  ]}
];
/* ========================= END QUESTIONS ========================= */

/* ---------- shuffle quiz each load ---------- */
function shuffle(a){ return a.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
let quiz = shuffle([...QUESTIONS]);
const total = quiz.length;

/* ---------- state ---------- */
let idx = 0;
let answers = new Array(total).fill(null);

/* ---------- DOM refs ---------- */
const intro = document.getElementById('intro');
const quizArea = document.getElementById('quizArea');
const qIndex = document.getElementById('qIndex');
const qText = document.getElementById('qText');
const optionsBox = document.getElementById('options');
const progress = document.getElementById('progress');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const statusMsg = document.getElementById('statusMsg');
const resultArea = document.getElementById('resultArea');
const resultBox = document.getElementById('resultBox');
const startBtn = document.getElementById('startBtn');
const cooldownNotice = document.getElementById('cooldownNotice');

/* ---------- cooldown (24 hours) ---------- */
const COOLDOWN_MS = 30 * 1000; // 30 seconds cooldown for demo
const STORAGE_KEY = 'aafat_apply_last_time';
checkCooldown();

function checkCooldown(){
  const last = parseInt(localStorage.getItem(STORAGE_KEY) || '0', 10);
  if(last && Date.now() - last < COOLDOWN_MS){
    const remaining = COOLDOWN_MS - (Date.now() - last);
    disableApplyButton(remaining);
  } else {
    cooldownNotice.textContent = '';
    startBtn.disabled = false;
  }
}

function disableApplyButton(msRemaining){
  startBtn.disabled = true;
  const tick = ()=>{
    if(msRemaining <= 0){
      startBtn.disabled = false;
      cooldownNotice.textContent = '';
      return;
    }
    const hrs = Math.floor(msRemaining / 3600000);
    const mins = Math.floor((msRemaining % 3600000) / 60000);
    const secs = Math.floor((msRemaining % 60000) / 1000);
    cooldownNotice.textContent = `⏳ Please wait ${hrs}h ${mins}m ${secs}s before reapplying.`;
    msRemaining -= 1000;
    setTimeout(tick, 1000);
  };
  tick();
}

/* ---------- events ---------- */
startBtn.addEventListener('click', startQuiz);
prevBtn.addEventListener('click', ()=>{ if(idx>0){ idx--; render(); }});
nextBtn.addEventListener('click', ()=>{
  if(!answers[idx]) { statusMsg.textContent='Please select an option to continue.'; return; }
  statusMsg.textContent='';
  if(idx < total-1){ idx++; render(); } else finish();
});

/* ---------- functions ---------- */
function startQuiz(){
  const name = document.getElementById('fullName').value.trim();
  const mc = document.getElementById('mcName').value.trim();
  const disc = document.getElementById('discord').value.trim();
  if(!name || !mc || !disc){ alert('Please fill all required fields.'); return; }
  // set cooldown timestamp now (locks reapply immediately)
  localStorage.setItem(STORAGE_KEY, Date.now().toString());
  checkCooldown();
  intro.classList.add('hidden');
  quizArea.classList.remove('hidden');
  render();
}

function render(){
  const q = quiz[idx];
  qIndex.textContent = `${idx+1}/${total}`;
  qText.textContent = q.text;
  optionsBox.innerHTML = '';
  q.options.forEach(o=>{
    const lbl = document.createElement('label');
    lbl.className = 'option';
    lbl.innerHTML = `<input type="radio" name="q${idx}" value="${o.id}" ${answers[idx]===o.id?'checked':''}> ${o.id}. ${o.text}`;
    lbl.addEventListener('click', ()=>{ answers[idx] = o.id; });
    optionsBox.appendChild(lbl);
  });
  progress.textContent = `Question ${idx+1} of ${total}`;
  prevBtn.disabled = idx===0;
  nextBtn.textContent = idx===total-1 ? 'Submit' : 'Next';
}

function finish(){
  // compute score and details
  let score = 0;
  const details = [];
  quiz.forEach((q, i)=>{
    const sel = answers[i];
    const correctObj = q.options.find(o=>o.correct);
    const correctId = correctObj ? correctObj.id : null;
    const selText = q.options.find(o=>o.id===sel)?.text || '—';
    const correctText = correctObj ? correctObj.text : '—';
    const isCorrect = sel === correctId;
    if(isCorrect) score++;
    details.push({ q: q.text, selected: selText, correct: correctText, isCorrect });
  });

  quizArea.classList.add('hidden');
  resultArea.classList.remove('hidden');

  const pass = score >= 2; // 2+ correct to whitelist
  resultBox.innerHTML = `<div style="color:${pass? '#00ffff':'#ff6666'}; font-weight:700">Score: ${score}/${total}</div>
    <p id="resultMsg">${pass? '✅ You are whitelisted!' : '❌ You did not pass. Try again later.'}</p>`;

  if(pass) playSuccessAnimation();

  // send webhooks
  sendAdminWebhook(details, score, pass).then(()=>sendStatusWebhook(pass)).catch(err=>{
    console.error('Webhook error', err);
    // still attempt status webhook
    sendStatusWebhook(pass).catch(e=>console.error(e));
  });
}

/* ---------- success visual (confetti + glow) ---------- */
function playSuccessAnimation(){
  const resultMsg = document.getElementById('resultMsg');
  if(resultMsg) resultMsg.classList.add('glow-pass');
  // small confetti burst
  const confettiCount = 50;
  for(let i=0;i<confettiCount;i++){
    const el = document.createElement('div');
    el.className = 'confetti';
    el.style.left = (Math.random()*100) + 'vw';
    const palettes = ['#00ffff','#66f0ff','#a277ff','#d8b3ff','#6ff3e1'];
    el.style.background = palettes[Math.floor(Math.random()*palettes.length)];
    el.style.width = Math.floor(Math.random()*8)+6 + 'px';
    el.style.height = Math.floor(Math.random()*14)+8 + 'px';
    el.style.transform = `rotate(${Math.random()*360}deg)`;
    el.style.opacity = Math.random()*0.9 + 0.3;
    el.style.animationDelay = (Math.random()*0.6)+'s';
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 3000);
  }
}

/* ===================== WEBHOOKS ===================== */

/* Helper: extract numeric Discord ID from inputs like:
   <@123456789012345678>, <@!123...>, 123456789012345678, or plain text that contains ID.
*/
function extractDiscordId(input){
  if(!input) return null;
  const m1 = input.match(/<@!?(\\d{17,19})>/) || input.match(/<@!?(\\d{17,19})/);
  if(m1 && m1[1]) return m1[1];
  const m2 = input.match(/(\\d{17,19})/);
  if(m2) return m2[1];
  return null;
}

// Admin webhook: detailed summary with full Q/A
async function sendAdminWebhook(details, score, pass){
  if(!ADMIN_WEBHOOK_URL || !ADMIN_WEBHOOK_URL.startsWith('http')) return;
  const name = document.getElementById('fullName').value.trim();
  const mc = document.getElementById('mcName').value.trim();
  const age = document.getElementById('age').value.trim() || '—';
  const disc = document.getElementById('discord').value.trim();

  const answersText = details.map((d,i)=>`Q${i+1}: ${d.q}\nYour: ${d.selected}\nCorrect: ${d.correct}\n${d.isCorrect? '✅':'❌'}`).join('\n\n');

  const embed = {
    title: "Application Received — Aafat Gaming",
    color: pass ? 3066993 : 15158332,
    fields: [
      { name: "Name", value: name, inline:true },
      { name: "Minecraft", value: mc, inline:true },
      { name: "Age", value: age, inline:true },
      { name: "Discord", value: disc, inline:true },
      { name: "Score", value: `${score}/${total}`, inline:true },
      { name: "Whitelisted?", value: pass ? "Yes ✅" : "No ❌", inline:true },
      { name: "Answers (truncated)", value: answersText.slice(0,1000) }
    ],
    timestamp: new Date().toISOString()
  };

  const body = { username: "Aafat-Applications", embeds: [embed] };
  await fetch(ADMIN_WEBHOOK_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
}

// Status webhook: ping user and post accept/reject embed with image
async function sendStatusWebhook(pass){
  if(!STATUS_WEBHOOK_URL || !STATUS_WEBHOOK_URL.startsWith('http')) return;
  const name = document.getElementById('fullName').value.trim();
  const mc = document.getElementById('mcName').value.trim();
  const discInput = document.getElementById('discord').value.trim();
  const discordId = extractDiscordId(discInput);

  const content = discordId ? (pass ? `✅ <@${discordId}>` : `❌ <@${discordId}>`) : (discInput || '');

  let embed;
  if(pass){
    embed = {
      title: "WHITELIST ACCEPTED = [AAFAT Syndicate Roleplay 2]",
      description: "**You are now whitelisted!**\nFollow the rules & have fun!\nNeed help? Ask a staff member!\nEnjoy the game!",
      color: 3066993,
      image: { url: ACCEPT_IMAGE_URL },
      timestamp: new Date().toISOString(),
      footer: { text: "Aafat Gaming" }
    };
  } else {
    embed = {
      title: "WHITELIST REJECTED = [AAFAT Syndicate Roleplay 2]",
      description: "**Sorry, you have been rejected from the whitelist.**\nPlease check the rules and try again.\nNeed help? Ask a staff member!",
      color: 15158332,
      image: { url: REJECT_IMAGE_URL },
      timestamp: new Date().toISOString(),
      footer: { text: "Aafat Gaming" }
    };
  }

  const body = { username: "ASRP-Whitelist", content, embeds: [embed] };
  await fetch(STATUS_WEBHOOK_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });

  // secure whitelist API call with secret key
  if (WHITELIST_API_URL && WHITELIST_API_URL.startsWith('http')) {
    try {
      const discordId = extractDiscordId(discInput);
      await fetch(WHITELIST_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${API_SECRET_KEY}`
        },
        body: JSON.stringify({
          discordId: discordId,
          whitelisted: pass
        })
      });
    } catch (e) {
      console.warn("Secure whitelist API call failed", e);
    }
  }
}

/* ===================== initialization ===================== */
render(); // pre-render first question so UI is ready (won't show until quizArea visible)
</script>
</body>
</html>
